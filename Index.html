<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UZITUBE</title>
<style>
  :root{
    --bg:#0b0b10; --panel:#13131a; --panel2:#1a1a24; --border:#272738;
    --text:#ededf6; --muted:#a6a6bb; --accent:#8b5cf6; --accent2:#6d28d9;
    --danger:#ef4444; --ok:#22c55e;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  /* Top Nav */
  .top{
    position:sticky;top:0;z-index:50;display:flex;gap:12px;align-items:center;
    padding:10px 16px;background:var(--panel);border-bottom:1px solid var(--border)
  }
  .logo{font-weight:800;letter-spacing:.6px;color:var(--accent)}
  .search{display:flex;gap:8px;flex:1;max-width:900px}
  .input{
    flex:1;padding:10px 12px;border-radius:10px;background:var(--panel2);
    border:1px solid var(--border);color:var(--text);outline:none
  }
  .btn{
    padding:10px 14px;border:1px solid var(--border);border-radius:10px;
    background:var(--accent);color:#fff;font-weight:700;cursor:pointer
  }
  .btn.secondary{background:transparent;color:var(--text)}
  .btn:disabled{opacity:.6;cursor:default}
  /* Layout */
  .wrap{display:grid;grid-template-columns:240px 1fr;gap:16px;min-height:calc(100vh - 56px)}
  @media (max-width:1000px){.wrap{grid-template-columns:1fr}}
  aside{
    padding:12px;background:var(--panel);border-right:1px solid var(--border)
  }
  .side-section{margin-bottom:16px}
  .side-h{font-size:12px;color:var(--muted);margin:8px 6px}
  .pill{
    display:flex;align-items:center;gap:8px;justify-content:space-between;
    padding:8px 10px;border-radius:10px;background:var(--panel2);
    border:1px solid var(--border);margin:6px 0
  }
  .clear{font-size:11px;color:var(--muted);cursor:pointer}
  .clear:hover{color:#fff}
  .side-list{display:grid;gap:8px}
  .side-item{
    display:grid;grid-template-columns:88px 1fr;gap:8px;padding:6px;border-radius:10px;
    background:transparent;cursor:pointer
  }
  .side-item:hover{background:var(--panel2)}
  .thumb-sm{
    width:100%;aspect-ratio:16/9;border-radius:8px;border:1px solid var(--border);object-fit:cover;background:#000
  }
  .side-title{font-size:12px;line-height:1.2}
  .side-meta{font-size:11px;color:var(--muted)}
  /* Main */
  main{padding:16px}
  .player-card{
    background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px;margin-bottom:16px
  }
  .player{width:100%;aspect-ratio:16/9;border:0;border-radius:12px;background:#000}
  .now-title{font-size:18px;font-weight:800;margin:10px 0 4px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .meta{font-size:12px;color:var(--muted)}
  .tag{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel2);color:var(--muted)}
  .actions{margin-left:auto;display:flex;gap:8px}
  .tiny{padding:6px 10px;border-radius:8px}
  .status{font-size:12px;color:var(--muted);margin-top:4px}
  .status.error{color:var(--danger)}
  /* Grid */
  .grid{
    display:grid;gap:14px;
    grid-template-columns:repeat(4,minmax(0,1fr))
  }
  @media (max-width:1400px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:640px){.grid{grid-template-columns:1fr}}
  .card{
    background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden;cursor:pointer;display:grid
  }
  .card:hover{transform:translateY(-1px)}
  .thumb{width:100%;aspect-ratio:16/9;object-fit:cover;background:#000}
  .card-b{
    padding:10px;display:grid;gap:8px
  }
  .title{font-size:14px;line-height:1.3}
  .muted{font-size:12px;color:var(--muted)}
  .row-mini{display:flex;gap:6px;align-items:center}
  .add-btn{
    margin-left:auto;border:1px solid var(--border);background:transparent;color:var(--text);
    font-size:12px;border-radius:8px;padding:6px 8px;cursor:pointer
  }
  .add-btn:hover{background:var(--panel2)}
  /* Spinner */
  .spinner{width:20px;height:20px;border:3px solid var(--panel2);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .flex{display:flex;align-items:center;gap:8px}
  .hidden{display:none}
  footer{padding:24px 0;color:var(--muted);text-align:center}
</style>
</head>
<body>
  <div class="top">
    <div class="logo">UZITUBE</div>
    <div class="search">
      <input id="input" class="input" placeholder="Paste channel URL (/channel/UC...), @handle, or channel ID (UC…)" />
      <button id="load" class="btn">Load</button>
      <button id="trending" class="btn secondary">Trending</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Sidebar -->
    <aside>
      <div class="side-section">
        <div class="side-h">Watch later</div>
        <div class="pill">
          <span id="wlCount">0 items</span>
          <span id="wlClear" class="clear">clear</span>
        </div>
        <div id="wlList" class="side-list"></div>
      </div>

      <div class="side-section">
        <div class="side-h">History</div>
        <div class="pill">
          <span id="histCount">0 items</span>
          <span id="histClear" class="clear">clear</span>
        </div>
        <div id="histList" class="side-list"></div>
      </div>
    </aside>

    <!-- Main -->
    <main>
      <section class="player-card">
        <iframe id="player" class="player" allowfullscreen></iframe>
        <div class="now-title" id="nowTitle">Nothing playing</div>
        <div class="row">
          <div class="meta" id="nowMeta"></div>
          <span class="tag" id="feedTag" hidden></span>
          <div class="actions">
            <button id="prev" class="btn tiny secondary">◀ Prev</button>
            <button id="next" class="btn tiny secondary">Next ▶</button>
            <button id="addWL" class="btn tiny">+ Watch later</button>
          </div>
        </div>
        <div class="status" id="status"></div>
      </section>

      <div class="flex" id="loading" style="margin:8px 0"><div class="spinner"></div><div class="muted">Loading…</div></div>
      <section id="grid" class="grid"></section>
      <footer>Powered by UZITUBE • No Google API • RSS + Embeds</footer>
    </main>
  </div>

<script>
/* ---------- State ---------- */
const el = (id)=>document.getElementById(id);
const input = el('input'), loadBtn = el('load'), trendingBtn = el('trending');
const player = el('player'), nowTitle = el('nowTitle'), nowMeta = el('nowMeta');
const feedTag = el('feedTag'), statusEl = el('status'), grid = el('grid'), loading = el('loading');
const prevBtn = el('prev'), nextBtn = el('next'), addWLBtn = el('addWL');
const wlList = el('wlList'), wlCount = el('wlCount'), wlClear = el('wlClear');
const histList = el('histList'), histCount = el('histCount'), histClear = el('histClear');

const LS_WL = 'uzitube_watchlater';
const LS_HIST = 'uzitube_history';

let currentFeed = [];     // [{id,title,published,thumb}]
let currentIndex = -1;    // index into currentFeed
let currentChannelId = ''; // for subscriptions later if desired

/* ---------- Utils ---------- */
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const ago = (d)=>{
  const s = Math.max(1, Math.floor((Date.now()-d.getTime())/1000));
  const u=[['yr',31536000],['mo',2592000],['d',86400],['h',3600],['m',60],['s',1]];
  for(const [k,v] of u){ if(s>=v) return `${Math.floor(s/v)}${k} ago`; }
  return 'just now';
};
const esc = (s)=>s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

/* CORS helper. */
const viaProxy = (url)=>`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;

/* Extract channel id from input. Supports:
   - UC… id
   - https://www.youtube.com/channel/UC…
   - https://youtube.com/@handle or @handle (resolved by scraping page via proxy)
*/
async function resolveChannelId(raw){
  if(!raw) return '';
  const s = raw.trim();
  if(s.startsWith('UC')) return s;
  const m = s.match(/youtube\.com\/channel\/([A-Za-z0-9_-]+)/i);
  if(m) return m[1];
  const at = s.startsWith('@') ? s : (s.match(/youtube\.com\/(@[A-Za-z0-9._-]+)/i)?.[1]);
  if(at){
    // scrape handle page for "channelId":"UC..."
    const htmlRes = await fetch(viaProxy(`https://www.youtube.com/${at}`));
    if(!htmlRes.ok) return '';
    const data = await htmlRes.json();
    const match = data.contents.match(/"channelId":"(UC[0-9A-Za-z_-]+)"/);
    return match ? match[1] : '';
  }
  return '';
}

/* ---------- Feed Loading ---------- */
async function loadFromInput(){
  setStatus('');
  showLoading(true);
  const id = await resolveChannelId(input.value);
  if(!id){ setStatus('Provide a valid channel URL, @handle, or UC… id.', true); showLoading(false); return; }
  currentChannelId = id;
  feedTag.hidden = false; feedTag.textContent = `channel_id: ${id.slice(0,8)}…`;
  await loadChannelFeed(id);
  showLoading(false);
}

async function loadChannelFeed(channelId){
  try{
    const feedUrl = `https://www.youtube.com/feeds/videos.xml?channel_id=${encodeURIComponent(channelId)}`;
    const res = await fetch(viaProxy(feedUrl));
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const { contents } = await res.json();
    const xml = new DOMParser().parseFromString(contents,'text/xml');
    const entries = Array.from(xml.querySelectorAll('entry'));
    if(entries.length===0){ setStatus('No videos found.', true); grid.innerHTML=''; return; }
    currentFeed = entries.map(parseEntry);
    renderGrid(currentFeed);
    playIndex(0);
    setStatus(`Loaded ${currentFeed.length} videos.`);
  }catch(err){
    setStatus(`Failed to load. ${err.message}`, true);
  }
}

function parseEntry(node){
  const title = node.querySelector('title')?.textContent || 'Untitled';
  const link = node.querySelector('link')?.getAttribute('href') || '';
  const id = link ? new URL(link).searchParams.get('v') :
                   (node.querySelector('yt\\:videoId, videoId')?.textContent || '');
  const published = new Date(node.querySelector('published')?.textContent || Date.now());
  const thumb = `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
  return { id, title, published, thumb };
}

/* ---------- Rendering ---------- */
function renderGrid(items){
  grid.innerHTML = '';
  for(const [i,v] of items.entries()){
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <img class="thumb" src="${v.thumb}" alt="">
      <div class="card-b">
        <div class="title">${esc(v.title)}</div>
        <div class="row-mini">
          <div class="muted">${ago(v.published)}</div>
          <button class="add-btn" title="Add to Watch later">+ Later</button>
        </div>
      </div>`;
    card.querySelector('.thumb').addEventListener('click', ()=>playIndex(i));
    card.querySelector('.title').addEventListener('click', ()=>playIndex(i));
    card.querySelector('.add-btn').addEventListener('click', (e)=>{ e.stopPropagation(); addToWatchLater(v); });
    grid.appendChild(card);
  }
}

function playIndex(i){
  if(i<0 || i>=currentFeed.length) return;
  currentIndex = i;
  const v = currentFeed[i];
  playVideo(v);
}

function playVideo(v){
  if(!v?.id) return;
  player.src = `https://www.youtube.com/embed/${encodeURIComponent(v.id)}?autoplay=1`;
  nowTitle.textContent = v.title;
  nowMeta.textContent = `Published ${v.published.toLocaleDateString()}`;
  addToHistory(v);
}

function setStatus(msg, error=false){
  statusEl.textContent = msg || '';
  statusEl.classList.toggle('error', !!error);
}

function showLoading(on){ loading.style.display = on ? 'flex' : 'none'; }

/* ---------- Watch Later ---------- */
function getWL(){ return JSON.parse(localStorage.getItem(LS_WL) || '[]'); }
function setWL(list){ localStorage.setItem(LS_WL, JSON.stringify(list)); renderWL(); }
function addToWatchLater(v){
  const wl = getWL();
  if(!wl.find(x=>x.id===v.id)){ wl.unshift({id:v.id,title:v.title,thumb:v.thumb}); setWL(wl); }
}
function renderWL(){
  const wl = getWL();
  wlCount.textContent = `${wl.length} item${wl.length===1?'':'s'}`;
  wlList.innerHTML = '';
  for(const item of wl){
    const li = document.createElement('div');
    li.className='side-item';
    li.innerHTML = `
      <img class="thumb-sm" src="${item.thumb}" alt="">
      <div>
        <div class="side-title">${esc(item.title)}</div>
        <div class="side-meta">Watch later</div>
      </div>`;
    li.addEventListener('click', ()=>playVideo(item));
    wlList.appendChild(li);
  }
}
wlClear.addEventListener('click', ()=>{ setWL([]); });

/* ---------- History ---------- */
function getHist(){ return JSON.parse(localStorage.getItem(LS_HIST) || '[]'); }
function setHist(list){ localStorage.setItem(LS_HIST, JSON.stringify(list)); renderHist(); }
function addToHistory(v){
  const hist = getHist().filter(x=>x.id!==v.id);
  hist.unshift({id:v.id,title:v.title,thumb:v.thumb,ts:Date.now()});
  if(hist.length>100) hist.pop();
  setHist(hist);
}
function renderHist(){
  const hist = getHist();
  histCount.textContent = `${hist.length} item${hist.length===1?'':'s'}`;
  histList.innerHTML = '';
  for(const item of hist){
    const li = document.createElement('div');
    li.className='side-item';
    const when = new Date(item.ts);
    li.innerHTML = `
      <img class="thumb-sm" src="${item.thumb}" alt="">
      <div>
        <div class="side-title">${esc(item.title)}</div>
        <div class="side-meta">${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
      </div>`;
    li.addEventListener('click', ()=>playVideo(item));
    histList.appendChild(li);
  }
}
histClear.addEventListener('click', ()=>{ setHist([]); });

/* ---------- Controls ---------- */
prevBtn.addEventListener('click', ()=>{ if(currentIndex>0) playIndex(currentIndex-1); });
nextBtn.addEventListener('click', ()=>{ if(currentIndex<currentFeed.length-1) playIndex(currentIndex+1); });
addWLBtn.addEventListener('click', ()=>{ if(currentIndex>=0) addToWatchLater(currentFeed[currentIndex]); });

/* Keyboard: j/k or ←/→ to prev/next, l to add later */
document.addEventListener('keydown', (e)=>{
  if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
  if(e.key==='ArrowLeft' || e.key==='j') prevBtn.click();
  if(e.key==='ArrowRight' || e.key==='k') nextBtn.click();
  if(e.key.toLowerCase()==='l') addWLBtn.click();
});

/* ---------- Trending (playlist feed) ---------- */
async function loadTrending(){
  setStatus('');
  showLoading(true);
  // "Most Popular" global playlist. Works as a rough trending feed.
  const playlistId = 'PLrEnWoR732-BHrPp_Pm8_VleD68f9s14-';
  const url = `https://www.youtube.com/feeds/videos.xml?playlist_id=${encodeURIComponent(playlistId)}`;
  try{
    const res = await fetch(viaProxy(url));
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const { contents } = await res.json();
    const xml = new DOMParser().parseFromString(contents,'text/xml');
    const entries = Array.from(xml.querySelectorAll('entry'));
    currentFeed = entries.map(parseEntry);
    currentChannelId = '';
    feedTag.hidden = false; feedTag.textContent = 'Trending';
    renderGrid(currentFeed);
    playIndex(0);
    setStatus(`Loaded ${currentFeed.length} trending videos.`);
  }catch(err){
    setStatus(`Failed to load trending. ${err.message}`, true);
  }finally{
    showLoading(false);
  }
}

/* ---------- Boot ---------- */
loadBtn.addEventListener('click', loadFromInput);
trendingBtn.addEventListener('click', loadTrending);
input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadFromInput(); });
renderWL(); renderHist();
setStatus('Paste a channel URL, @handle, or UC… id, or click Trending.');
showLoading(false);
</script>
</body>
</html>
